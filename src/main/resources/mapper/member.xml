<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="kr.or.ddit.member.mapper.MemberMapper">
	<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 로그인 및 회원가입 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->
	
	<!--  로그인  -->  
	<select id="selectUser" resultType="memberVo" parameterType="String">
		select *
		from member 
		where member_mail = #{member_mail}
	</select>
	
	<!-- 회원가입  -->
	<insert id="insertUser" parameterType="memberVo">    
		insert into 
		member
		values (#{member_mail},#{member_name},#{member_pass},#{member_tel},'/images/basic.png','N')
	</insert>
	
	<update id="updateUser" parameterType="memberVo">    
		update member
		set member_pass = #{member_pass}, member_tel = #{member_tel} , member_name = #{member_name}
		<if test="member_profile != null">, member_profile = #{member_profile, jdbcType=VARCHAR} </if>
		where member_mail = #{member_mail}
	</update>
	
	<!-- 아이디 찾기 -->
	<select id="selectfindId" resultType="memberVo" parameterType="String">
		select *
		from member 
		where member_tel = #{member_tel}
		and member_name = #{member_name}
	</select>
	
	<!-- 비밀번호 찾기 -->
	<select id="selectfindPass" parameterType="String" resultType="memberVo">
		select *
		from member 
		where member_mail=#{member_mail}
	</select>

	<!-- 비밀번호 변경 -->
	<update id="updatePass" parameterType="memberVo">
		update member
		set member_pass = #{member_pass}
		where member_mail = #{member_mail}
	</update>
	
	<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  마이페이지 부분  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->
	<!--  참여중인 프로젝트  -->
	<select id="myprojectselect" resultType="projectVo" parameterType="pageVo">
		
	select * from(
	    select rownum rnum ,a.*
	             from
	                  (SELECT (SELECT PROJECT_TITLE  FROM PROJECT  WHERE PROJECT_ID = PMEMBER_PROJECT) as project_title
	                       , PMEMBER_MEMBER as pmember_member
	                      , PMEMBER_PROJECT as project_id
	                   FROM   PROJECT_MEMBER
	                   WHERE  PMEMBER_MEMBER = #{member_mail}
	                     AND    PMEMBER_POSITION = '2'
	                   UNION
	                   SELECT  (SELECT PROJECT_TITLE FROM PROJECT WHERE PROJECT_ID = PMEMBER_PROJECT)
	                       , (SELECT B.PMEMBER_MEMBER FROM PROJECT_MEMBER B WHERE B.PMEMBER_PROJECT = A.PMEMBER_PROJECT AND B.PMEMBER_POSITION = 1)
	                     , PMEMBER_PROJECT
	                   FROM   PROJECT_MEMBER A
	                   WHERE  A.PMEMBER_MEMBER = #{member_mail}
	                     AND    A.PMEMBER_POSITION = '2')a)
	   where rnum between ${page}*${pageSize}-(${pageSize}-1) 
	   and ${page}*${pageSize}
		<if test="searchText!=null and searchText!=''">and project_title like '%'||#{searchText}||'%'</if>
	</select>
	
	<!-- 참여했던 프로젝트  -->
	<select id="myprojectEndselect" resultType="projectVo" parameterType="pageVo">
		
		select * from(
	    select rownum rnum ,a.*
	             from
	                  (SELECT (SELECT PROJECT_TITLE  FROM PROJECT  WHERE PROJECT_ID = PMEMBER_PROJECT) as project_title
	                       , PMEMBER_MEMBER as pmember_member
	                      , PMEMBER_PROJECT as project_id
	                     FROM   PROJECT_MEMBER A , PROJECT B
                      where B.project_id = A.pmember_project 
	                   AND  PMEMBER_MEMBER = #{member_mail}
                            AND    PMEMBER_POSITION = '1'
                        AND   project_eedate is not null
	                   UNION
	                   SELECT  (SELECT PROJECT_TITLE FROM PROJECT WHERE PROJECT_ID = PMEMBER_PROJECT)
	                       , (SELECT B.PMEMBER_MEMBER FROM PROJECT_MEMBER B WHERE B.PMEMBER_PROJECT = A.PMEMBER_PROJECT AND B.PMEMBER_POSITION = 1)
	                     , PMEMBER_PROJECT
	                   FROM   PROJECT_MEMBER A , PROJECT B
                      where B.project_id = A.pmember_project 
	                   AND  A.PMEMBER_MEMBER = #{member_mail}
	                     AND    A.PMEMBER_POSITION = '2'
                          AND    B.project_eedate is not null)a)
 		 where rnum between ${page}*${pageSize}-(${pageSize}-1) 
	   and ${page}*${pageSize}
		<if test="searchEndText!=null and searchEndText!=''">and project_title like '%'||#{searchEndText}||'%'</if>
	</select>
	
	<!-- 프로젝트 전체 개수 가져오기  -->	
	<select id="totalProjectCnt" resultType="int" parameterType="String">
		select count(*)
		from   project_member
		where  pmember_member = #{member_mail}
	 </select>
	 
	 <select id="selectProjectCnt" resultType="int" parameterType="String">
	 	SELECT  count(*)
		FROM    project_member
		WHERE   pmember_member = #{member_mail}
		AND     pmember_bookmark = 'Y'
	 </select>
	 
	 <select id="selectTodoCnt" resultType="int" parameterType="String">
	 	select count(*)
		from   todo
		where  todo_pmember = #{member_mail}
	 
	 </select>
	 
	 <select id="totalEndProjectCnt" resultType="int" parameterType="String">
	 	select count(*) from project
		where project_eedate is not null
	 
	 </select>
	 
	 <!-- 참여중인 프로젝트 : project_tile 값으로 project_id 얻어오기  -->
	 <select id="selectProjectId" resultType="projectVo" parameterType="String">
	  select project_id 
	  from   project 
	  where  project_title = #{project_title}	
	 </select>
	 

	<!--  즐겨찾기한 프로젝트  -->
	<select id = "mybookmarkselect" resultType="projectVo" parameterType="pageVo">
		
		select * from
		    (select ROWNUM rnum, a.*
		     from
		        (SELECT  p.project_title  as project_title,
		         		 p.project_id as project_id,
		                pmem.pmember_member as pmember_member
		        FROM    project p INNER JOIN project_member pm
		        ON      p.project_id = pm.pmember_project LEFT JOIN (SELECT pmember_project,
		                                                                    pmember_member
		                                                             FROM   project_member
		                                                             WHERE  pmember_position = 1) pmem
		        ON      p.project_id = pmem.pmember_project
		        WHERE   pm.pmember_member = #{member_mail}
		        AND     pm.pmember_bookmark = 'Y')a)
		   		where rnum between ${page}*${pageSize}-(${pageSize}-1) AND ${page}*${pageSize}
		<if test="searchBookText!=null and searchBookText!=''">and project_title like '%'||#{searchBookText}||'%'</if>
	</select>
	
	
	<!-- 회원탈퇴 update  -->
	<update id="updateUserwithDrawal" parameterType="projectVo">	
		update member
		set member_withdrawal = 'Y'
		where member_mail  = #{member_mail}
	</update>
	
	
	<select id="myTodoselect" resultType="todoVo" parameterType="pageVo">
		    select * from
		    (select ROWNUM rnum, a.*
		     from
		        (select todo_content
                      , todo_complet
                from todo
                where pmember_member = #{member_mail})a)
		  where rnum between ${page}*${pageSize}-(${pageSize}-1) AND ${page}*${pageSize}
		<if test="searchTodoText != null and searchTodoText != ''">and todo_content like '%'||#{searchTodoText}||'%'</if>
	</select>
	
	<select id="myFileList" resultType="attVo" parameterType="pageVo">
		select * from
		   (select ROWNUM rnum, a.*
		    from
		       (select att_name
			       from   attachment inner join work on att_work = work_id  
			              inner join  project on work_project = project_id
			              inner join  project_member on project_id = pmember_project
			              inner join  member on pmember_member = member_mail
			               where  member_mail = #{member_mail})a)
			        where rnum between ${page}*${pageSize}-(${pageSize}-1) AND ${page}*${pageSize} 
		        <if test="searchFileList != null and searchFileList != ''">and att_name like '%'||#{searchFileList}||'%'</if>
	</select>


	 <select id="myFileListCnt" resultType="int" parameterType="String">
		select count(*)
		from   attachment, member
		where  member_mail = #{member_mail}
	 </select>
	 
	 <select id="selectProjectMember" resultType="projectVo" parameterType="String">
		select project_title 
		from project 
		inner join project_member
			on project_id = pmember_project inner join member
			on pmember_member = member_mail
		where member_mail = #{member_mail}
	 </select>
	
	 
</mapper>

