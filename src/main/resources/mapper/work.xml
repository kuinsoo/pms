<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.work.mapper.WorkMapper">

	<!-- 업무 전체 일정 -->
	<select id="workAllSchedule" resultType="workVo" parameterType="scheduleVo">
	<!-- 일정에 필요한 컬럼 정리: 업무제목, 업무시작일자, 업무예상마감일자, 업무마감일자, 업무일정색깔 -->
		SELECT	w.work_title,
				w.work_sdate,
				w.work_eedate,
				w.work_edate,
				w.work_color
		<choose>
			<when test="pid != null">
				FROM	work w
				WHERE	work_project = #{pid}
			</when>
			<otherwise>
				FROM    work_member wm INNER JOIN project_member pm
				ON      wm.pmember_id = pm.pmember_id INNER JOIN work w
				ON      wm.work_id = w.work_id
				WHERE   pm.pmember_member = #{sid}
			</otherwise>
		</choose>
	</select>
	
	<!-- 로그인 한 회원의 업무 생성 알림 2018-12-18 임규승 -->
	<select id="workMember" resultType="workVo" parameterType="String">
	SELECT  A.WORK_TITLE
	    ,   A.WORK_ID
	    ,   A.WORK_PROJECT
	FROM    WORK A, WORK_MEMBER B, PROJECT_MEMBER C, MEMBER D
	WHERE   A.WORK_ID			= B.WORK_ID
	AND     B.PMEMBER_ID		= C.PMEMBER_ID
	AND     C.PMEMBER_MEMBER	= D.MEMBER_MAIL
	AND     D.MEMBER_MAIL		= #{member_mail}
	ORDER	BY A.WORK_ID DESC
	</select>

	<select id="selectWorks" resultType="workVo" parameterType="String">
		select W.WORK_ID,
			   W.WORK_TITLE,
			   W.WORK_CONTENT,
			   W.WORK_WDATE,
			   W.WORK_TYPE,
			   W.WORK_PROJECT,
			   W.WORK_IMPORTANCE,
			   W.WORK_SDATE,
			   W.WORK_EEDATE,
			   W.WORK_EDATE,
			   W.WORK_PROGRESS,
			   W.WORK_APPROVAL,
			   W.WORK_PUBLIC,
			   M.MEMBER_MAIL,
			   M.MEMBER_PROFILE
		from MEMBER M INNER JOIN PROJECT_MEMBER PM on (M.MEMBER_MAIL = PM.PMEMBER_MEMBER)
			INNER JOIN WORK_MEMBER WM on (PM.PMEMBER_ID = WM.PMEMBER_ID )
			INNER JOIN WORK W on (WM.WORK_ID = W.WORK_ID)
			where W.WORK_PROJECT = #{work_project}
		ORDER by to_number(W.WORK_ID) desc
	</select>

	<insert id="createWork" parameterType="workVo">
		insert into work 
		values(SEQ_WORK.NEXTVAL, #{work_project}, #{work_title}, #{work_content}, #{work_type}, ${work_importance},
					 #{work_sdate}, #{work_eedate},0, 'N','',#{work_public},'#4286f4',sysdate)
	</insert>

	<delete id="deleteWork" parameterType="String">
		DELETE FROM WORK WHERE WORK_ID = #{work_id}
	</delete>

	<update id="updateWork" parameterType="workVo">
		UPDATE WORK
		SET WORK_TITLE = #{work_title}, WORK_CONTENT = #{work_content}, WORK_TYPE = #{work_type},
		 WORK_IMPORTANCE = ${work_importance},  WORK_SDATE = #{work_sdate}, WORK_EEDATE = #{work_eedate},
		 WORK_PROGRESS = #{work_progress}, WORK_EDATE = #{work_edate} , WORK_PUBLIC = #{work_public},
		 WORK_COLOR = #{work_color}
		WHERE work_id = #{work_id}
	</update>

	<insert id="insertWorkMember" parameterType="Map">
		insert into work_member values (seq_work.currval, (SELECT PMEMBER_ID
														   FROM PROJECT_MEMBER
														   WHERE PMEMBER_MEMBER = #{pmember_member}
															 and PMEMBER_PROJECT = #{pmember_project}))
	</insert>




</mapper>
